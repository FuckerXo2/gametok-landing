<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GameTOK Admin</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { 
      font-size: 28px; 
      margin-bottom: 24px;
      background: linear-gradient(135deg, #FF6B6B, #FF8E53);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .login-form, .admin-content { display: none; }
    .login-form.active, .admin-content.active { display: block; }
    
    .login-form {
      max-width: 400px;
      margin: 100px auto;
      padding: 32px;
      background: #1a1a1a;
      border-radius: 16px;
    }
    .login-form h2 { margin-bottom: 20px; text-align: center; }
    .login-form input {
      width: 100%;
      padding: 14px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #0a0a0a;
      color: #fff;
      font-size: 16px;
      margin-bottom: 16px;
    }
    .login-form button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #FF6B6B, #FF8E53);
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      border-bottom: 1px solid #333;
      padding-bottom: 12px;
    }
    .tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: #888;
      font-size: 15px;
      cursor: pointer;
      border-radius: 8px;
    }
    .tab.active { background: #FF8E53; color: #fff; }
    
    .add-game-form {
      background: #1a1a1a;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
    .form-row input, .form-row select {
      flex: 1;
      padding: 12px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #0a0a0a;
      color: #fff;
      font-size: 14px;
    }
    .form-row input::placeholder { color: #666; }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary { background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: #fff; }
    .btn-danger { background: #e74c3c; color: #fff; }
    .btn-small { padding: 8px 16px; font-size: 12px; }
    
    .games-list { display: grid; gap: 12px; }
    .game-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #1a1a1a;
      border-radius: 12px;
    }
    .game-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .game-thumb {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      object-fit: cover;
    }
    .game-info { flex: 1; }
    .game-name { font-weight: 600; margin-bottom: 4px; }
    .game-url { font-size: 12px; color: #888; word-break: break-all; }
    .game-actions { display: flex; gap: 8px; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-value { font-size: 32px; font-weight: 700; color: #FF8E53; }
    .stat-label { font-size: 14px; color: #888; margin-top: 4px; }
    
    .thumbnail-upload {
      border: 2px dashed #333;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s;
      position: relative;
    }
    .thumbnail-upload:hover { border-color: #FF8E53; }
    .thumbnail-upload.uploading { border-color: #FF8E53; opacity: 0.7; }
    .thumbnail-upload input[type="file"] {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      opacity: 0;
      cursor: pointer;
    }
    .thumbnail-preview {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      margin-top: 10px;
    }
    .upload-text { color: #888; font-size: 14px; }
    .upload-text span { color: #FF8E53; }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-form active" id="loginForm">
      <h2>üéÆ GameTOK Admin</h2>
      <input type="password" id="password" placeholder="Enter admin password">
      <button onclick="login()">Login</button>
    </div>
    
    <div class="admin-content" id="adminContent">
      <h1>üéÆ GameTOK Admin</h1>
      
      <div class="tabs">
        <button class="tab active" onclick="showTab('games')">Games</button>
        <button class="tab" onclick="showTab('reports')">Reports</button>
        <button class="tab" onclick="showTab('config')">Config</button>
        <button class="tab" onclick="showTab('stats')">Stats</button>
      </div>
      
      <div id="gamesTab">
        <div class="add-game-form" style="margin-bottom: 16px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 1px solid #FF8E53;">
          <h3 style="margin-bottom: 16px;">üöÄ Bulk Import from GameMonetize</h3>
          <p style="color: #888; margin-bottom: 16px; font-size: 14px;">Import thousands of mobile-ready games instantly</p>
          <div class="form-row">
            <select id="importCategory" style="flex: 1;">
              <option value="">All Categories</option>
              <option value="arcade">Arcade</option>
              <option value="puzzle">Puzzle</option>
              <option value="racing">Racing</option>
              <option value="sports">Sports</option>
              <option value="action">Action</option>
              <option value="adventure">Adventure</option>
              <option value="hypercasual">Hypercasual</option>
              <option value="girls">Girls</option>
              <option value="boys">Boys</option>
              <option value="shooting">Shooting</option>
              <option value="multiplayer">Multiplayer</option>
            </select>
            <input type="number" id="importCount" placeholder="Number of games" value="500" min="10" max="5000" style="flex: 1;">
            <button class="btn btn-primary" onclick="bulkImport()" id="importBtn">Import Games</button>
          </div>
          <div class="form-row" style="margin-top: 12px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #4ECDC4;">
              <input type="checkbox" id="portraitOnly" style="width: 18px; height: 18px;">
              <span>üì± Portrait games only (vertical, best for phones)</span>
            </label>
          </div>
          <div class="form-row" style="margin-top: 12px;">
            <button class="btn btn-primary btn-small" onclick="triggerSizeScan()" id="scanBtn" style="background: #4ECDC4;">üìä Scan Game Sizes</button>
            <button class="btn btn-danger btn-small" onclick="deleteLargeGames()" id="deleteLargeBtn" style="margin-left: 8px;">üóëÔ∏è Delete Large Games (>8MB)</button>
            <button class="btn btn-danger btn-small" onclick="deleteLandscapeGames()" id="deleteLandscapeBtn" style="margin-left: 8px;">üóëÔ∏è Delete Landscape Games</button>
          </div>
          <div class="form-row" style="margin-top: 8px;">
            <span style="color: #888; font-size: 12px;">Scan runs on GitHub Actions (free). Results update automatically.</span>
          </div>
          <div id="importStatus" style="margin-top: 12px; color: #4ECDC4; font-size: 14px;"></div>
        </div>
        
        <div class="add-game-form">
          <h3 style="margin-bottom: 16px;">Add New Game</h3>
          <div class="form-row">
            <input type="text" id="gameName" placeholder="Game Name" oninput="autoGenerateId()">
            <input type="text" id="gameId" placeholder="Game ID (auto-generated)" style="color: #888;">
          </div>
          <div class="form-row">
            <input type="text" id="gameUrl" placeholder="Game URL (optional)">
          </div>
          <div class="form-row">
            <input type="text" id="gameDesc" placeholder="Description (optional)">
            <select id="gameCategory">
              <option value="arcade">Arcade</option>
              <option value="puzzle">Puzzle</option>
              <option value="action">Action</option>
              <option value="casual">Casual</option>
              <option value="sports">Sports</option>
              <option value="strategy">Strategy</option>
              <option value="retro">Retro</option>
            </select>
          </div>
          <div class="form-row">
            <div style="flex: 1;">
              <div class="thumbnail-upload" id="thumbnailUpload">
                <input type="file" accept="image/*" onchange="uploadThumbnail(event)">
                <div class="upload-text">üì∑ <span>Click to upload thumbnail</span></div>
                <div id="thumbnailPreviewContainer"></div>
              </div>
              <input type="hidden" id="gameThumbnail">
            </div>
          </div>
          <button class="btn btn-primary" onclick="addGame()">Add Game</button>
        </div>
        
        <h3 style="margin-bottom: 16px;">All Games (<span id="gameCount">0</span>)</h3>
        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <input type="text" id="gameSearch" placeholder="üîç Search games..." oninput="filterGames()" style="flex: 1; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #0a0a0a; color: #fff; font-size: 14px;">
          <input type="text" id="bulkDeleteIds" placeholder="Game IDs to delete (comma separated)" style="flex: 1; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #0a0a0a; color: #fff; font-size: 14px;">
          <button class="btn btn-danger" onclick="bulkDeleteGames()">Delete Listed</button>
        </div>
        <div class="games-list" id="gamesList"></div>
      </div>
      
      <div id="statsTab" style="display: none;">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalGames">0</div>
            <div class="stat-label">Total Games</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalUsers">0</div>
            <div class="stat-label">Total Users</div>
          </div>
        </div>
      </div>
      
      <div id="reportsTab" style="display: none;">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="pendingReports">0</div>
            <div class="stat-label">Pending Reports</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="resolvedReports">0</div>
            <div class="stat-label">Resolved (24h)</div>
          </div>
        </div>
        
        <h3 style="margin-bottom: 16px;">‚ö†Ô∏è Pending Reports</h3>
        <div class="games-list" id="reportsList">
          <p style="color: #888; text-align: center; padding: 40px;">Loading reports...</p>
        </div>
      </div>
      
      <div id="configTab" style="display: none;">
        <div class="add-game-form">
          <h3 style="margin-bottom: 16px;">‚öôÔ∏è Remote Config</h3>
          <p style="color: #888; margin-bottom: 20px; font-size: 14px;">Change app behavior without pushing updates</p>
          
          <div class="form-row">
            <div style="flex: 1;">
              <label style="display: block; color: #888; font-size: 12px; margin-bottom: 6px;">Ad Frequency (show ad every X games)</label>
              <input type="number" id="configAdFrequency" min="1" max="20" value="3" style="width: 100%;">
            </div>
            <div style="flex: 1;">
              <label style="display: block; color: #888; font-size: 12px; margin-bottom: 6px;">Min App Version</label>
              <input type="text" id="configMinVersion" value="1.0.0" style="width: 100%;">
            </div>
          </div>
          
          <div class="form-row" style="margin-top: 16px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="configMaintenance" style="width: 20px; height: 20px;">
              <span style="color: #e74c3c;">üö® Maintenance Mode (disables app)</span>
            </label>
          </div>
          
          <button class="btn btn-primary" onclick="saveConfig()" style="margin-top: 20px;">Save Config</button>
          <span id="configStatus" style="margin-left: 12px; color: #4ECDC4;"></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = 'https://gametok-backend-production.up.railway.app';
    const ADMIN_PASSWORD = 'gametok2024';
    
    // Cloudinary config - UPDATE THESE WITH YOUR VALUES
    const CLOUDINARY_CLOUD_NAME = 'dujntgrjd';
    const CLOUDINARY_UPLOAD_PRESET = 'gametok_unsigned';
    
    function login() {
      const pwd = document.getElementById('password').value;
      if (pwd === ADMIN_PASSWORD) {
        document.getElementById('loginForm').classList.remove('active');
        document.getElementById('adminContent').classList.add('active');
        loadGames();
        loadStats();
      } else {
        alert('Wrong password');
      }
    }
    
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('gamesTab').style.display = tab === 'games' ? 'block' : 'none';
      document.getElementById('statsTab').style.display = tab === 'stats' ? 'block' : 'none';
      document.getElementById('configTab').style.display = tab === 'config' ? 'block' : 'none';
      document.getElementById('reportsTab').style.display = tab === 'reports' ? 'block' : 'none';
      if (tab === 'config') loadConfig();
      if (tab === 'reports') loadReports();
    }
    
    async function loadConfig() {
      try {
        const res = await fetch(`${API}/api/config`);
        const config = await res.json();
        document.getElementById('configAdFrequency').value = config.adFrequency || 3;
        document.getElementById('configMinVersion').value = config.minAppVersion || '1.0.0';
        document.getElementById('configMaintenance').checked = config.maintenanceMode || false;
      } catch (e) {
        console.error(e);
      }
    }
    
    async function saveConfig() {
      const adFrequency = parseInt(document.getElementById('configAdFrequency').value);
      const minAppVersion = document.getElementById('configMinVersion').value;
      const maintenanceMode = document.getElementById('configMaintenance').checked;
      
      try {
        const res = await fetch(`${API}/api/admin/config`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adFrequency, minAppVersion, maintenanceMode })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('configStatus').textContent = '‚úì Saved!';
          setTimeout(() => document.getElementById('configStatus').textContent = '', 2000);
        }
      } catch (e) {
        alert('Failed to save config');
      }
    }
    
    async function uploadThumbnail(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const uploadBox = document.getElementById('thumbnailUpload');
      const previewContainer = document.getElementById('thumbnailPreviewContainer');
      
      uploadBox.classList.add('uploading');
      previewContainer.innerHTML = '<div class="upload-text">Uploading...</div>';
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      formData.append('folder', 'gametok/thumbnails');
      
      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        
        if (data.secure_url) {
          document.getElementById('gameThumbnail').value = data.secure_url;
          previewContainer.innerHTML = `<img src="${data.secure_url}" class="thumbnail-preview" alt="Thumbnail">`;
          uploadBox.querySelector('.upload-text').innerHTML = '‚úÖ <span>Uploaded! Click to change</span>';
        } else {
          throw new Error(data.error?.message || 'Upload failed');
        }
      } catch (e) {
        console.error(e);
        previewContainer.innerHTML = '';
        uploadBox.querySelector('.upload-text').innerHTML = '‚ùå <span>Upload failed. Try again</span>';
        alert('Failed to upload: ' + e.message);
      }
      
      uploadBox.classList.remove('uploading');
    }
    
    let allGames = [];
    
    async function loadGames() {
      try {
        const res = await fetch(`${API}/api/admin/games`);
        const data = await res.json();
        allGames = data.games;
        document.getElementById('gameCount').textContent = data.games.length;
        renderGames(data.games);
      } catch (e) {
        console.error(e);
      }
    }
    
    function renderGames(games) {
      document.getElementById('gamesList').innerHTML = games.map(g => `
        <div class="game-item">
          ${g.thumbnail 
            ? `<img src="${g.thumbnail}" class="game-thumb" alt="${g.name}">`
            : `<div class="game-icon" style="background: ${g.color}">${g.icon}</div>`
          }
          <div class="game-info">
            <div class="game-name">${g.name} ${g.fileSize ? `<span style="color: ${g.fileSize > 8*1024*1024 ? '#e74c3c' : '#4ECDC4'}; font-size: 12px;">(${(g.fileSize/1024/1024).toFixed(1)}MB)</span>` : ''}</div>
            <div class="game-url">${g.embedUrl || 'Self-hosted: ' + g.id}</div>
          </div>
          <div class="game-actions">
            <button class="btn btn-danger btn-small" onclick="deleteGame('${g.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }
    
    async function bulkDeleteGames() {
      const idsInput = document.getElementById('bulkDeleteIds').value;
      if (!idsInput.trim()) {
        alert('Enter game IDs to delete (comma separated)');
        return;
      }
      
      const ids = idsInput.split(',').map(id => id.trim()).filter(id => id);
      if (ids.length === 0) {
        alert('No valid IDs found');
        return;
      }
      
      if (!confirm('Delete ' + ids.length + ' games? IDs: ' + ids.join(', '))) return;
      
      let deleted = 0;
      for (const id of ids) {
        try {
          const res = await fetch(API + '/api/admin/games/' + id, { method: 'DELETE' });
          const data = await res.json();
          if (data.success) deleted++;
        } catch (e) {
          console.error('Failed to delete ' + id);
        }
      }
      
      alert('Deleted ' + deleted + ' of ' + ids.length + ' games');
      document.getElementById('bulkDeleteIds').value = '';
      loadGames();
      loadStats();
    }
    
    function filterGames() {
      const query = document.getElementById('gameSearch').value.toLowerCase();
      if (!query) {
        renderGames(allGames);
        return;
      }
      const filtered = allGames.filter(g => 
        g.name.toLowerCase().includes(query) || 
        g.id.toLowerCase().includes(query) ||
        (g.category && g.category.toLowerCase().includes(query))
      );
      renderGames(filtered);
    }
    
    async function loadStats() {
      try {
        const gamesRes = await fetch(`${API}/api/games?limit=1000`);
        const gamesData = await gamesRes.json();
        document.getElementById('totalGames').textContent = gamesData.total || 0;
        document.getElementById('totalUsers').textContent = '-';
      } catch (e) {
        console.error(e);
      }
    }
    
    async function addGame() {
      const id = document.getElementById('gameId').value.trim();
      const name = document.getElementById('gameName').value.trim();
      const embedUrl = document.getElementById('gameUrl').value.trim();
      const description = document.getElementById('gameDesc').value.trim();
      const category = document.getElementById('gameCategory').value;
      const thumbnail = document.getElementById('gameThumbnail').value.trim();
      
      if (!id || !name) {
        alert('ID and Name are required');
        return;
      }
      
      try {
        const res = await fetch(`${API}/api/admin/games`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, name, description, category, embedUrl: embedUrl || null, thumbnail: thumbnail || null })
        });
        const data = await res.json();
        if (data.success) {
          alert('Game added!');
          // Clear form
          document.getElementById('gameId').value = '';
          document.getElementById('gameName').value = '';
          document.getElementById('gameUrl').value = '';
          document.getElementById('gameDesc').value = '';
          document.getElementById('gameThumbnail').value = '';
          document.getElementById('thumbnailPreviewContainer').innerHTML = '';
          document.querySelector('#thumbnailUpload .upload-text').innerHTML = 'üì∑ <span>Click to upload thumbnail</span>';
          loadGames();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (e) {
        alert('Failed to add game');
      }
    }
    
    async function deleteGame(id) {
      if (!confirm(`Delete game "${id}"?`)) return;
      try {
        const res = await fetch(`${API}/api/admin/games/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          loadGames();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (e) {
        alert('Failed to delete game');
      }
    }
    
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
    
    function autoGenerateId() {
      const name = document.getElementById('gameName').value;
      const id = name.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
      document.getElementById('gameId').value = id;
    }
    
    async function loadReports() {
      try {
        const res = await fetch(`${API}/api/admin/reports`);
        const data = await res.json();
        const reports = data.reports || [];
        const pending = reports.filter(r => r.status === 'pending');
        const resolved = reports.filter(r => r.status !== 'pending');
        
        document.getElementById('pendingReports').textContent = pending.length;
        document.getElementById('resolvedReports').textContent = resolved.length;
        
        if (pending.length === 0) {
          document.getElementById('reportsList').innerHTML = '<p style="color: #4ECDC4; text-align: center; padding: 40px;">‚úÖ No pending reports!</p>';
          return;
        }
        
        document.getElementById('reportsList').innerHTML = pending.map(r => `
          <div class="game-item" style="flex-direction: column; align-items: flex-start;">
            <div style="display: flex; width: 100%; gap: 16px; align-items: center;">
              <div class="game-icon" style="background: #e74c3c;">‚ö†Ô∏è</div>
              <div class="game-info" style="flex: 1;">
                <div class="game-name">Report #${r.id} - ${r.reason}</div>
                <div class="game-url">Reported user: ${r.reported_username || r.reported_user_id} | By: ${r.reporter_username || r.reporter_id}</div>
                <div class="game-url" style="margin-top: 4px;">${r.details || 'No additional details'}</div>
                <div class="game-url" style="color: #FF8E53;">${new Date(r.created_at).toLocaleString()}</div>
              </div>
              <div class="game-actions" style="flex-direction: column; gap: 8px;">
                <button class="btn btn-danger btn-small" onclick="actionReport(${r.id}, 'ban')">Ban User</button>
                <button class="btn btn-small" style="background: #f39c12;" onclick="actionReport(${r.id}, 'warn')">Warn</button>
                <button class="btn btn-small" style="background: #27ae60;" onclick="actionReport(${r.id}, 'dismiss')">Dismiss</button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
        document.getElementById('reportsList').innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 40px;">Failed to load reports</p>';
      }
    }
    
    async function actionReport(reportId, action) {
      const actions = { ban: 'banned', warn: 'warned', dismiss: 'dismissed' };
      if (!confirm(`Are you sure you want to ${action} this report?`)) return;
      
      try {
        const res = await fetch(`${API}/api/admin/reports/${reportId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, status: actions[action] })
        });
        const data = await res.json();
        if (data.success) {
          alert(`Report ${actions[action]} successfully`);
          loadReports();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Failed to action report');
      }
    }
    
    async function bulkImport() {
      const count = parseInt(document.getElementById('importCount').value) || 500;
      const category = document.getElementById('importCategory').value;
      const portraitOnly = document.getElementById('portraitOnly').checked;
      const btn = document.getElementById('importBtn');
      const status = document.getElementById('importStatus');
      
      btn.disabled = true;
      btn.textContent = 'Importing...';
      let filterInfo = portraitOnly ? ' (portrait only)' : '';
      status.textContent = `‚è≥ Fetching ${count} games from GameMonetize...${filterInfo}`;
      
      try {
        const res = await fetch(`${API}/api/admin/import-gamemonetize`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ count, category: category || undefined, portraitOnly })
        });
        const data = await res.json();
        
        if (data.success) {
          status.innerHTML = `‚úÖ <strong>Imported ${data.imported} games!</strong> (${data.skipped} duplicates) | Total: ${data.totalGames} games`;
          loadGames();
          loadStats();
        } else {
          status.innerHTML = `‚ùå Error: ${data.error}`;
        }
      } catch (e) {
        status.innerHTML = `‚ùå Failed to import: ${e.message}`;
      }
      
      btn.disabled = false;
      btn.textContent = 'Import Games';
    }
    
    let scanStatusInterval = null;
    
    async function triggerSizeScan() {
      const btn = document.getElementById('scanBtn');
      const status = document.getElementById('importStatus');
      
      btn.disabled = true;
      btn.textContent = 'Triggering...';
      status.textContent = '‚è≥ Starting game size scan on GitHub Actions...';
      
      try {
        const res = await fetch(`${API}/api/admin/trigger-size-scan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        
        if (data.success) {
          status.innerHTML = `‚úÖ <strong>Scan triggered!</strong> Checking status... <a href="https://github.com/FuckerXo2/gametok-backend/actions" target="_blank" style="color: #FF8E53;">(View on GitHub)</a>`;
          
          // Start polling for status
          if (scanStatusInterval) clearInterval(scanStatusInterval);
          scanStatusInterval = setInterval(checkScanStatus, 5000); // Check every 5 seconds
          checkScanStatus(); // Check immediately
        } else {
          status.innerHTML = `‚ùå Error: ${data.error}`;
          btn.disabled = false;
          btn.textContent = 'üìä Scan Game Sizes';
        }
      } catch (e) {
        status.innerHTML = `‚ùå Failed to trigger scan: ${e.message}`;
        btn.disabled = false;
        btn.textContent = 'üìä Scan Game Sizes';
      }
    }
    
    async function checkScanStatus() {
      const btn = document.getElementById('scanBtn');
      const status = document.getElementById('importStatus');
      
      try {
        const res = await fetch(`${API}/api/admin/scan-status`);
        const data = await res.json();
        
        if (data.status === 'in_progress') {
          const progress = data.scannedGames && data.totalGames 
            ? ` (${data.scannedGames}/${data.totalGames} games)`
            : '';
          status.innerHTML = `‚è≥ <strong>Scanning in progress...</strong>${progress} <a href="https://github.com/FuckerXo2/gametok-backend/actions" target="_blank" style="color: #FF8E53;">(View on GitHub)</a>`;
        } else if (data.status === 'completed') {
          clearInterval(scanStatusInterval);
          status.innerHTML = `‚úÖ <strong>Scan completed!</strong> ${data.scannedGames || 0} games scanned. Refreshing list...`;
          btn.disabled = false;
          btn.textContent = 'üìä Scan Game Sizes';
          loadGames(); // Refresh the games list
        } else if (data.status === 'failed') {
          clearInterval(scanStatusInterval);
          status.innerHTML = `‚ùå <strong>Scan failed.</strong> Check <a href="https://github.com/FuckerXo2/gametok-backend/actions" target="_blank" style="color: #FF8E53;">GitHub Actions</a> for details.`;
          btn.disabled = false;
          btn.textContent = 'üìä Scan Game Sizes';
        } else {
          // No active scan or queued
          clearInterval(scanStatusInterval);
          btn.disabled = false;
          btn.textContent = 'üìä Scan Game Sizes';
        }
      } catch (e) {
        console.error('Failed to check scan status:', e);
      }
    }
    
    async function deleteLargeGames() {
      if (!confirm('This will delete ALL games larger than 8MB (based on scanned sizes). Run size scan first! Continue?')) return;
      
      const btn = document.getElementById('deleteLargeBtn');
      const status = document.getElementById('importStatus');
      
      btn.disabled = true;
      btn.textContent = 'Deleting...';
      status.textContent = '‚è≥ Deleting large games...';
      
      try {
        const res = await fetch(`${API}/api/admin/delete-large-games`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ maxSizeMB: 8 })
        });
        const data = await res.json();
        
        if (data.success) {
          let msg = `‚úÖ <strong>Deleted ${data.deleted} large games!</strong> | Remaining: ${data.remaining} games`;
          if (data.unknownSize > 0) {
            msg += ` | ${data.unknownSize} games have unknown size`;
          }
          status.innerHTML = msg;
          loadGames();
          loadStats();
        } else {
          status.innerHTML = `‚ùå Error: ${data.error}`;
        }
      } catch (e) {
        status.innerHTML = `‚ùå Failed to delete: ${e.message}`;
      }
      
      btn.disabled = false;
      btn.textContent = 'üóëÔ∏è Delete Large Games (>8MB)';
    }
    
    async function deleteLandscapeGames() {
      if (!confirm('This will delete ALL landscape (horizontal) GameMonetize games. Continue?')) return;
      
      const btn = document.getElementById('deleteLandscapeBtn');
      const status = document.getElementById('importStatus');
      
      btn.disabled = true;
      btn.textContent = 'Deleting...';
      status.textContent = '‚è≥ Checking game dimensions and deleting landscape games...';
      
      try {
        const res = await fetch(`${API}/api/admin/delete-landscape-games`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        
        if (data.success) {
          status.innerHTML = `‚úÖ <strong>Deleted ${data.deleted} landscape games!</strong> | Remaining: ${data.remaining} games`;
          loadGames();
          loadStats();
        } else {
          status.innerHTML = `‚ùå Error: ${data.error}`;
        }
      } catch (e) {
        status.innerHTML = `‚ùå Failed to delete: ${e.message}`;
      }
      
      btn.disabled = false;
      btn.textContent = 'üóëÔ∏è Delete Landscape Games';
    }
  </script>
</body>
</html>